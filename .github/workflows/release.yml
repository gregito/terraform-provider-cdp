name: Periodic Release Job

on:
  schedule:
    - cron: '*/15 * * * *'

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest release
        id: fetch_latest_release
        run: |
          LATEST_RELEASE_TAG=$(curl -s https://api.github.com/repos/gregito/terraform-provider-cdp/releases | jq '.[].tag_name' | head -n 1 | sed 's/"//g')
          echo "Latest release tag: $LATEST_RELEASE_TAG"
          echo "latest_release_tag=$LATEST_RELEASE_TAG" >> $GITHUB_OUTPUT
      - name: Check out code
        id: checkout_code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch latest commit
        id: fetch_latest_commit
        run: |
          git fetch --tags
          LATEST_COMMIT_TAG=$(git describe --tags --abbrev=0)
          echo "Latest commit tag: $LATEST_COMMIT_TAG"
          echo "latest_commit_tag=$LATEST_COMMIT_TAG" >> $GITHUB_OUTPUT
      - name: Setup Go
        uses: actions/setup-go@fac708d6674e30b6ba41289acaab6d4b75aa0753 # v4.0.1
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Run GoReleaser
        if: steps.fetch_latest_release.outputs.latest_release_tag != steps.fetch_latest_commit.outputs.latest_commit_tag
        uses: goreleaser/goreleaser-action@v5.0.0
        with:
          args: release --clean
          draft: false
        env:
          # GitHub sets the GITHUB_TOKEN secret automatically.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}